<!DOCTYPE html>
<html>

<head>
    <title>Gestão de Frota</title>

    <link rel="stylesheet" href="stylegestao.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body>
    <h2 id = 'titulo' style="text-align: center;" class="text text-success">Gestão de Frota
    </h2>
    <div class="container">
        <div class="cadastro">
            <h2 id = 'titcad'>Cadastro de Abastecimento</h2>
            <form action="#">
                <div id="inputboxes">
                    
                    <label class = 'legendainput'> Data Abast  .:</label><input type="date" class="form-control" id="dataab"  name="dataab"> <input type="time" class="form-control" id="horaab"  name="horaab"><label class = 'legendainput'>     Placa </label><input stype="text" class="form-control" id="placavei" placeholder="Placa" name="placavei" onchange="ultimokm()"><label class = 'legendainput'> KM Atual: </label><input type="number" class="form-control" id="kmatual" placeholder="KM Atual" name="kmatual" > 
                </div>
                <p></p>
                <div class="form-group" >
                    <label class = 'legendainput'>Litros Abast.:</label><input type="number" class="form-control" id="litrosabast" placeholder="Litros" name="litrosabast" onchange="mostrarmedia()"><label class = 'legendainput'>Valor Abast.:</label><input type="number" class="form-control" id="valorabastec" placeholder="Valor Tot." name="valorabast"> 
                    <p></p>
                    <div id = 'kmanterior'></div>
                <p></p>
                <button type="button" onclick="createData()" id="save_btn" class="btn btn-default">Cadastrar</button>
                <button type="button" onclick="listarabastecimentos()" id="save_btn" class="btn btn-default">Listar Ab</button>
                
            </form>
        </div>
        
        <div class="col-sm-6">
            <h2 style="text-align: center;">Abastecimentos</h2>
            <div class="row">
                <table id = 'cablistaabast'>
                    <tr>
                        <td id = "cabdataabas">Data Abast</td>
                        <td id = "cabplacavei">Placa</td>
                        <td id = "cabkmatual">KM Atual</td>
                        <td id = "cablitros">Litros</td>
                    </tr>
                </table>
            </div>
            <div id="listaabast"></div>
        </div>
    </div>
    <table></table>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-database.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDeE0KQGpzHKUi6OEGZ3ocoldMNH8w5q1M",
            authDomain: "gestao-de-frota-65ec9.firebaseapp.com",
            databaseURL: "https://gestao-de-frota-65ec9-default-rtdb.firebaseio.com",
            projectId: "gestao-de-frota-65ec9",
            storageBucket: "gestao-de-frota-65ec9.appspot.com",
            messagingSenderId: "1036423159731",
            appId: "1:1036423159731:web:c7ea8a6d2c7b59a20535c6",
            measurementId: "G-NTDT5XKJB0"
        };
        firebase.initializeApp(firebaseConfig);

        // Create a new data
        function createData() {

            
            var checkdataabast= document.getElementById("dataab").value + " " + document.getElementById("horaab").value
            var checkplacavei= document.getElementById("placavei").value.toUpperCase()
            var checkkmatual= document.getElementById("kmatual").value
            var checklitros= document.getElementById('litrosabast').value
            var checkvalorabast= document.getElementById('valorabastec').value




            const newData = {
                dataabast: document.getElementById("dataab").value + " " + document.getElementById("horaab").value,
                placavei: document.getElementById("placavei").value.toUpperCase(),
                kmatual: document.getElementById("kmatual").value,
                litros: document.getElementById('litrosabast').value,
                valorabastec: document.getElementById('valorabastec').value

            };

            if(checkplacavei != "" && checkdataabast.length == 16  && checkkmatual != "" && checklitros != "" && checkvalorabast != "") {

                firebase
                    .database()
                    .ref("abastecimentos/")
                    .push(newData);
                    
            }else if (checkdataabast.length < 16) {
                    window.alert('[ERRO] Data incorreta!')


            }else{
                    window.alert('[ERRO] Faltam dados')
            
            }

                    
        }
            
            




       

        // Read data

        function listarabastecimentos(){
            firebase
                .database()
                .ref("abastecimentos/")
                .orderByChild('dataabast')
                // .startAt("2023-01-01 00:00")
                // .endAt("2023-01-31 23:59")
                // .limitToLast(1)
                .on("value", function (snapshot) {

                    document.getElementById("listaabast").innerHTML = "";
                    snapshot.forEach(function (childSnapshot) {
                        var key = childSnapshot.key;
                        var childData = childSnapshot.val();
                        let addDiv = document.createElement('div');
                        addDiv.className = "row";
                        addDiv.innerHTML = `
                            <table id = 'tablelistaabast'>
                            
                            <tr> 
                            <td id= "coldataabas">
                            ${childData.dataabast.slice(8,10)+'/' //data
                            +childData.dataabast.slice(5,7)+'/'            //data
                            +childData.dataabast.slice(0,4)+' '            //data
                            +childData.dataabast.slice(11,13)+':'          //data
                            +childData.dataabast.slice(14,17)}</td>        
                            <td id= "colplacavei">${childData.placavei}</td> 
                            <td id= "colkmatual">${childData.kmatual}</td>  
                            <td id= "collitros">${childData.litros}</td>  
                            <td>${'<button type="button"  class="btn btn-info" onclick="updateData()">Update</button><button type="button" class="btn btn-danger" onclick="deleteData()">Delete</button></div>'}</td> 
                            </tr>
                            </table>`   
                        document.getElementById("listaabast").appendChild(addDiv);
                        
                    });
                        
            });


        }

        function ultimokm(){
             
            firebase
                .database()
                .ref("abastecimentos/")
                .orderByChild('dataabast')
                // .startAt("2023-01-01 00:00")
                // .endAt("2023-01-31 23:59")
                .limitToLast(1)
                .on("value", function (snapshot) {
                    
                    document.getElementById("kmanterior").innerHTML = "";
                    snapshot.forEach(function (childSnapshot) {
                        var key = childSnapshot.key;
                        var childData = childSnapshot.val();
                        var addDiv2 = document.createElement('div');
                        addDiv2.className = "row";
                        addDiv2.id = 'divkmanterior'
                        console.log(key)       
                        let placavei2 = document.getElementById("placavei").value.toUpperCase();
                        if (childData.placavei == placavei2) {
                            document.getElementById("kmanterior").appendChild(addDiv2);
                            var kmatualdig = document.getElementById('kmatual').value
                            
                            addDiv2.innerHTML = `O KM Anterior da placa ${childData.placavei} é ${childData.kmatual}.`


                                            
                        
                        }    

                    });
            
            });
        }
        var testeult = ultimokm()
        function mostrarmedia(){
            var limpardiv = document.getElementById('divkmanterior')
            limpardiv.innerHTML = ""
            firebase
                .database()
                .ref("abastecimentos/")
                .orderByChild('dataabast')
                // .startAt("2023-01-01 00:00")
                // .endAt("2023-01-31 23:59")
                .limitToLast(1)
                .on("value", function (snapshot) {

                    document.getElementById("kmanterior").innerHTML = "";
                    snapshot.forEach(function (childSnapshot) {
                        var key = childSnapshot.key;
                        var childData = childSnapshot.val();
                        var addDiv2 = document.createElement('div');
                        addDiv2.className = "row";
                        addDiv2.id = 'divkmanterior'
                        
                        let placavei2 = document.getElementById("placavei").value.toUpperCase();
                        if (childData.placavei == placavei2) {
                            document.getElementById("kmanterior").appendChild(addDiv2);
                            var kmatualdig = document.getElementById('kmatual').value
                            var litrosdig = document.getElementById('litrosabast').value
                            
                            addDiv2.innerHTML = `O KM Anterior da placa ${childData.placavei} é ${childData.kmatual}. [MÉDIA] ${((kmatualdig - childData.kmatual)/litrosdig).toFixed(2)}`

                                            

                        }    

                    });
                    
            });
        }
            
                
// 2023-02-02  19:07
// 01234567891011 12

// CRIAR VARIAS FUNÇOES EM DIVERSAS VARIAVEIS 

    </script>
</body>

</html>